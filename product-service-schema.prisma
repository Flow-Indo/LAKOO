// =============================================================================
// PRODUCT SERVICE DATABASE SCHEMA
// Service: product-service (Port 3002)
// Database: product_db
// Owner: Product catalog, variants, images, categories, wishlist
// =============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("PRODUCT_DATABASE_URL")
}

// =============================================================================
// CATEGORIES
// =============================================================================

model Category {
  id           String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  parentId     String?    @db.Uuid
  name         String     @db.VarChar(255)
  slug         String     @unique @db.VarChar(255)
  description  String?
  imageUrl     String?
  iconUrl      String?
  displayOrder Int        @default(0)
  level        Int        @default(0) // 0 = root, 1 = child, etc.
  path         String?    @db.VarChar(500) // Materialized path: "parent/child/grandchild"
  isActive     Boolean    @default(true)
  isFeatured   Boolean    @default(false)
  metaTitle    String?    @db.VarChar(255)
  metaDescription String?
  createdAt    DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime   @updatedAt @db.Timestamptz(6)
  deletedAt    DateTime?  @db.Timestamptz(6)

  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")
  products Product[]

  @@index([slug])
  @@index([parentId])
  @@index([isActive])
  @@index([path])
  @@index([deletedAt])
  @@map("category")
}

// =============================================================================
// PRODUCTS (Master catalog - warehouse products)
// NOTE: Product is the PARENT - it does NOT have a sellable SKU
// The actual sellable units are VARIANTS (product + color + size = SKU)
// =============================================================================

model Product {
  id               String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  categoryId       String        @db.Uuid
  supplierId       String?       @db.Uuid // Reference to Supplier Service
  // Base product code (NOT a sellable SKU - just for identification)
  productCode      String        @unique @db.VarChar(50)
  name             String        @db.VarChar(255)
  slug             String        @unique @db.VarChar(255)
  description      String?
  shortDescription String?       @db.VarChar(500)
  // Base pricing (variants have actual prices)
  baseCostPrice    Decimal       @db.Decimal(15, 2)
  baseSellPrice    Decimal       @db.Decimal(15, 2)
  // Default dimensions (variants can override)
  weightGrams      Int?
  lengthCm         Decimal?      @db.Decimal(10, 2)
  widthCm          Decimal?      @db.Decimal(10, 2)
  heightCm         Decimal?      @db.Decimal(10, 2)
  primaryImageUrl  String?
  grosirUnitSize   Int?          @default(12) // Units per grosir bundle
  material         String?       @db.VarChar(255)
  careInstructions String?
  countryOfOrigin  String?       @db.VarChar(100)
  status           ProductStatus @default(draft)
  metaTitle        String?       @db.VarChar(255)
  metaDescription  String?
  tags             String[]
  publishedAt      DateTime?     @db.Timestamptz(6)
  // Denormalized for performance (sync from Supplier Service)
  supplierName     String?       @db.VarChar(255)
  // Aggregated review data (sync from Review Service)
  avgRating        Decimal?      @db.Decimal(3, 2)
  reviewCount      Int           @default(0)
  // Audit fields
  createdBy        String?       @db.Uuid
  updatedBy        String?       @db.Uuid
  createdAt        DateTime      @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime      @updatedAt @db.Timestamptz(6)
  deletedAt        DateTime?     @db.Timestamptz(6)

  category  Category         @relation(fields: [categoryId], references: [id])
  variants  ProductVariant[]
  images    ProductImage[]
  wishlists WishlistItem[]

  @@index([categoryId])
  @@index([supplierId])
  @@index([productCode])
  @@index([slug])
  @@index([status])
  @@index([publishedAt])
  @@index([deletedAt])
  @@map("product")
}

// =============================================================================
// PRODUCT VARIANTS - THIS IS THE ACTUAL SKU (sellable unit)
// SKU = Product + Color + Size combination
// Example: TSHIRT-BASIC-RED-M, TSHIRT-BASIC-RED-L, TSHIRT-BASIC-BLUE-M
// =============================================================================

model ProductVariant {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId    String    @db.Uuid
  // THIS IS THE ACTUAL SKU - the sellable unit identifier
  sku          String    @unique @db.VarChar(100)
  // Variant attributes that DEFINE the SKU
  color        String    @db.VarChar(50) // Color code: "RED", "BLU", "BLK"
  colorHex     String?   @db.VarChar(7)  // Hex color for display
  colorName    String?   @db.VarChar(100) // Display name: "Crimson Red"
  size         String    @db.VarChar(50) // Size code: "S", "M", "L", "XL"
  sizeName     String?   @db.VarChar(100) // Display name: "Medium"
  // Additional attributes (optional)
  material     String?   @db.VarChar(100)
  style        String?   @db.VarChar(100)
  // Variant-specific pricing (actual prices for this SKU)
  costPrice    Decimal   @db.Decimal(15, 2)
  sellPrice    Decimal   @db.Decimal(15, 2)
  // Variant-specific dimensions (if different from product)
  weightGrams  Int?
  // Images
  imageUrl     String?
  // Barcode for this specific SKU
  barcode      String?   @unique @db.VarChar(100)
  // Display
  sortOrder    Int       @default(0)
  isDefault    Boolean   @default(false)
  isActive     Boolean   @default(true)
  // Timestamps
  createdAt    DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @db.Timestamptz(6)
  deletedAt    DateTime? @db.Timestamptz(6)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([productId, color, size]) // Ensures unique color+size per product
  @@index([productId])
  @@index([sku])
  @@index([color])
  @@index([size])
  @@index([barcode])
  @@index([isActive])
  @@index([deletedAt])
  @@map("product_variant")
}

model ProductImage {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId    String   @db.Uuid
  variantId    String?  @db.Uuid // Optional: variant-specific image
  imageUrl     String
  thumbnailUrl String?
  altText      String?  @db.VarChar(255)
  displayOrder Int      @default(0)
  isPrimary    Boolean  @default(false)
  width        Int?
  height       Int?
  sizeBytes    Int?
  createdAt    DateTime @default(now()) @db.Timestamptz(6)

  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@index([productId])
  @@index([variantId])
  @@map("product_image")
}

// =============================================================================
// WISHLIST
// =============================================================================

model Wishlist {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String   @unique @db.Uuid // Reference to Auth Service
  createdAt DateTime @default(now()) @db.Timestamptz(6)
  updatedAt DateTime @updatedAt @db.Timestamptz(6)

  items WishlistItem[]

  @@map("wishlist")
}

model WishlistItem {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  wishlistId String   @db.Uuid
  productId  String   @db.Uuid
  variantId  String?  @db.Uuid
  brandId    String?  @db.Uuid // Reference to Brand Service
  addedAt    DateTime @default(now()) @db.Timestamptz(6)
  // Snapshot at time of adding (for price drop notifications)
  priceAtAdd Decimal? @db.Decimal(15, 2)
  notifyOnPriceDrop Boolean @default(false)

  wishlist Wishlist @relation(fields: [wishlistId], references: [id], onDelete: Cascade)
  product  Product  @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([wishlistId, productId, variantId])
  @@index([wishlistId])
  @@index([productId])
  @@map("wishlist_item")
}

// =============================================================================
// PRODUCT VIEW ANALYTICS (for recommendations)
// =============================================================================

model ProductView {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  productId String   @db.Uuid
  userId    String?  @db.Uuid
  sessionId String?  @db.VarChar(100)
  source    String?  @db.VarChar(50) // search, category, recommendation, ad
  createdAt DateTime @default(now()) @db.Timestamptz(6)

  @@index([productId])
  @@index([userId])
  @@index([createdAt])
  @@map("product_view")
}

// =============================================================================
// SERVICE OUTBOX (For future Kafka migration)
// =============================================================================

model ServiceOutbox {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @db.VarChar(100)
  aggregateId   String    @db.Uuid
  eventType     String    @db.VarChar(100)
  payload       Json
  metadata      Json?
  isPublished   Boolean   @default(false)
  publishedAt   DateTime? @db.Timestamptz(6)
  retryCount    Int       @default(0)
  lastError     String?
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)

  @@index([isPublished, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("service_outbox")
}

// =============================================================================
// ENUMS
// =============================================================================

enum ProductStatus {
  draft
  pending_review
  active
  inactive
  out_of_stock
  discontinued
}
