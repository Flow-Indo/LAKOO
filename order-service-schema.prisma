// =============================================================================
// ORDER SERVICE DATABASE SCHEMA
// Service: order-service (Port 3006)
// Database: order_db
// Owner: Orders, order items, status history, returns, promotions/coupons
// =============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("ORDER_DATABASE_URL")
}

// =============================================================================
// ORDERS
// =============================================================================

model Order {
  id                  String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderNumber         String      @unique @db.VarChar(50) // ORD-20260115-XXXXX
  userId              String      @db.Uuid // Reference to Auth Service
  orderSource         OrderSource @default(brand)
  // Source references (mutually exclusive based on orderSource)
  brandId             String?     @db.Uuid // Reference to Brand Service
  sellerId            String?     @db.Uuid // Reference to Seller Service
  // Amounts
  subtotal            Decimal     @db.Decimal(15, 2)
  discountAmount      Decimal     @default(0) @db.Decimal(15, 2)
  shippingCost        Decimal     @default(0) @db.Decimal(15, 2)
  taxAmount           Decimal     @default(0) @db.Decimal(15, 2)
  totalAmount         Decimal     @db.Decimal(15, 2)
  currency            String      @default("IDR") @db.VarChar(3)
  // Coupon/Promotion
  couponId            String?     @db.Uuid
  couponCode          String?     @db.VarChar(50)
  // ==========================================================================
  // SHIPPING ADDRESS SNAPSHOT (frozen at order time)
  // ==========================================================================
  shippingAddressId   String?     @db.Uuid // Original address ID from Address Service
  shippingRecipient   String      @db.VarChar(255)
  shippingPhone       String      @db.VarChar(20)
  shippingStreet      String
  shippingDistrict    String?     @db.VarChar(100)
  shippingCity        String      @db.VarChar(100)
  shippingProvince    String      @db.VarChar(100)
  shippingPostalCode  String      @db.VarChar(10)
  shippingCountry     String      @default("Indonesia") @db.VarChar(100)
  shippingLatitude    Decimal?    @db.Decimal(10, 8)
  shippingLongitude   Decimal?    @db.Decimal(11, 8)
  // ==========================================================================
  // USER SNAPSHOT (frozen at order time)
  // ==========================================================================
  customerEmail       String?     @db.VarChar(255)
  customerPhone       String      @db.VarChar(20)
  customerName        String      @db.VarChar(255)
  // Shipping details
  shippingMethod      String?     @db.VarChar(100)
  shippingCourier     String?     @db.VarChar(50)
  estimatedDelivery   DateTime?   @db.Timestamptz(6)
  // Status
  status              OrderStatus @default(pending)
  // Notes
  customerNotes       String?
  internalNotes       String?
  // Timestamps
  paidAt              DateTime?   @db.Timestamptz(6)
  confirmedAt         DateTime?   @db.Timestamptz(6)
  processedAt         DateTime?   @db.Timestamptz(6)
  shippedAt           DateTime?   @db.Timestamptz(6)
  deliveredAt         DateTime?   @db.Timestamptz(6)
  completedAt         DateTime?   @db.Timestamptz(6)
  cancelledAt         DateTime?   @db.Timestamptz(6)
  cancelReason        String?     @db.VarChar(500)
  cancelledBy         String?     @db.VarChar(50) // "customer", "system", "admin"
  // Live commerce attribution
  liveSessionId       String?     @db.Uuid
  // Idempotency
  idempotencyKey      String?     @unique @db.VarChar(100)
  // Audit
  createdBy           String?     @db.Uuid
  updatedBy           String?     @db.Uuid
  createdAt           DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt           DateTime    @updatedAt @db.Timestamptz(6)
  deletedAt           DateTime?   @db.Timestamptz(6)

  items           OrderItem[]
  statusHistory   OrderStatusHistory[]
  returns         Return[]

  @@index([orderNumber])
  @@index([userId])
  @@index([brandId])
  @@index([sellerId])
  @@index([status])
  @@index([createdAt])
  @@index([deletedAt])
  @@map("order")
}

model OrderItem {
  id                String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId           String   @db.Uuid
  itemType          OrderItemType @default(brand_product)
  // Product references (from Product Service)
  productId         String?  @db.Uuid
  variantId         String?  @db.Uuid
  // Brand reference (from Brand Service)
  brandId           String?  @db.Uuid
  brandProductId    String?  @db.Uuid
  // Seller reference (from Seller Service)
  sellerProductId   String?  @db.Uuid
  sellerId          String?  @db.Uuid
  // ==========================================================================
  // PRODUCT SNAPSHOT (frozen at order time - NEVER changes)
  // ==========================================================================
  snapshotProductName String  @db.VarChar(255)
  snapshotVariantName String? @db.VarChar(255)
  snapshotSku         String? @db.VarChar(100)
  snapshotImageUrl    String?
  snapshotBrandName   String? @db.VarChar(255)
  snapshotSellerName  String? @db.VarChar(255)
  // Pricing
  unitPrice           Decimal @db.Decimal(15, 2)
  quantity            Int
  subtotal            Decimal @db.Decimal(15, 2)
  discountAmount      Decimal @default(0) @db.Decimal(15, 2)
  totalAmount         Decimal @db.Decimal(15, 2)
  // Fulfillment
  fulfilledQuantity   Int     @default(0)
  returnedQuantity    Int     @default(0)
  // Timestamps
  createdAt           DateTime @default(now()) @db.Timestamptz(6)

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([productId])
  @@map("order_item")
}

model OrderStatusHistory {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId     String      @db.Uuid
  fromStatus  OrderStatus?
  toStatus    OrderStatus
  reason      String?     @db.VarChar(500)
  notes       String?
  changedBy   String?     @db.Uuid // User ID or "system"
  changedByType String?   @db.VarChar(50) // "customer", "admin", "system"
  metadata    Json?
  createdAt   DateTime    @default(now()) @db.Timestamptz(6)

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@index([orderId])
  @@index([createdAt])
  @@map("order_status_history")
}

// =============================================================================
// RETURNS (7-day return policy)
// =============================================================================

model Return {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  returnNumber    String       @unique @db.VarChar(50) // RET-20260115-XXXXX
  orderId         String       @db.Uuid
  userId          String       @db.Uuid
  // Return details
  returnType      ReturnType   @default(refund)
  reason          ReturnReason
  reasonDetail    String?      @db.VarChar(500)
  customerNotes   String?
  // Items being returned
  items           Json         // Array of {orderItemId, quantity, reason}
  // Amounts
  subtotalAmount  Decimal      @db.Decimal(15, 2)
  shippingRefund  Decimal      @default(0) @db.Decimal(15, 2)
  totalAmount     Decimal      @db.Decimal(15, 2)
  // Return shipping
  returnShipmentId String?     @db.Uuid // Reference to Logistics Service
  returnTrackingNo String?     @db.VarChar(100)
  returnCourier    String?     @db.VarChar(50)
  // Inspection
  inspectedAt      DateTime?   @db.Timestamptz(6)
  inspectedBy      String?     @db.Uuid
  inspectionNotes  String?
  itemCondition    ItemCondition?
  // Status
  status           ReturnStatus @default(requested)
  // Evidence
  images           Json?       // Array of image URLs
  // Refund details
  refundMethod     String?     @db.VarChar(50) // "original_payment", "wallet", "bank_transfer"
  refundedAt       DateTime?   @db.Timestamptz(6)
  // Admin
  approvedBy       String?     @db.Uuid
  approvedAt       DateTime?   @db.Timestamptz(6)
  rejectedBy       String?     @db.Uuid
  rejectedAt       DateTime?   @db.Timestamptz(6)
  rejectionReason  String?     @db.VarChar(500)
  // Timestamps
  requestedAt      DateTime    @default(now()) @db.Timestamptz(6)
  deadline         DateTime    @db.Timestamptz(6) // Must be requested within 7 days
  createdAt        DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt        DateTime    @updatedAt @db.Timestamptz(6)

  order Order @relation(fields: [orderId], references: [id])

  @@index([returnNumber])
  @@index([orderId])
  @@index([userId])
  @@index([status])
  @@map("return")
}

// =============================================================================
// PROMOTIONS & COUPONS
// =============================================================================

model Coupon {
  id                 String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code               String       @unique @db.VarChar(50)
  name               String       @db.VarChar(255)
  description        String?
  discountType       DiscountType
  discountValue      Decimal      @db.Decimal(15, 2) // Amount or percentage
  // Conditions
  minOrderAmount     Decimal?     @db.Decimal(15, 2)
  maxDiscountAmount  Decimal?     @db.Decimal(15, 2) // Cap for percentage discounts
  // Usage limits
  totalUsageLimit    Int?         // Total times coupon can be used
  perUserLimit       Int          @default(1) // Times per user
  usedCount          Int          @default(0)
  // Restrictions
  applicableBrandIds String[]     @db.Uuid // Empty = all brands
  applicableCategoryIds String[]  @db.Uuid // Empty = all categories
  applicableProductIds String[]   @db.Uuid // Empty = all products
  excludedProductIds String[]     @db.Uuid
  newCustomersOnly   Boolean      @default(false)
  // Validity
  startsAt           DateTime     @db.Timestamptz(6)
  expiresAt          DateTime     @db.Timestamptz(6)
  isActive           Boolean      @default(true)
  // Source
  source             CouponSource @default(manual)
  liveSessionId      String?      @db.Uuid // If from live commerce
  campaignId         String?      @db.Uuid // If from ad campaign
  // Audit
  createdBy          String?      @db.Uuid
  createdAt          DateTime     @default(now()) @db.Timestamptz(6)
  updatedAt          DateTime     @updatedAt @db.Timestamptz(6)
  deletedAt          DateTime?    @db.Timestamptz(6)

  usages CouponUsage[]

  @@index([code])
  @@index([isActive])
  @@index([startsAt, expiresAt])
  @@index([deletedAt])
  @@map("coupon")
}

model CouponUsage {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  couponId     String   @db.Uuid
  userId       String   @db.Uuid
  orderId      String   @db.Uuid
  discountAmount Decimal @db.Decimal(15, 2)
  usedAt       DateTime @default(now()) @db.Timestamptz(6)

  coupon Coupon @relation(fields: [couponId], references: [id], onDelete: Cascade)

  @@index([couponId])
  @@index([userId])
  @@index([orderId])
  @@map("coupon_usage")
}

// =============================================================================
// SERVICE OUTBOX (For future Kafka migration)
// =============================================================================

model ServiceOutbox {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @db.VarChar(100)
  aggregateId   String    @db.Uuid
  eventType     String    @db.VarChar(100)
  payload       Json
  metadata      Json?
  isPublished   Boolean   @default(false)
  publishedAt   DateTime? @db.Timestamptz(6)
  retryCount    Int       @default(0)
  lastError     String?
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)

  @@index([isPublished, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("service_outbox")
}

// =============================================================================
// ENUMS
// =============================================================================

enum OrderSource {
  brand          // From LAKOO brands (warehouse)
  seller         // From third-party sellers
  live_commerce  // From live streaming session
}

enum OrderItemType {
  brand_product
  seller_product
}

enum OrderStatus {
  pending            // Order created, awaiting payment
  awaiting_payment   // Payment initiated
  paid               // Payment confirmed
  confirmed          // Order confirmed by system/seller
  processing         // Being prepared
  ready_to_ship      // Ready for pickup
  shipped            // Handed to courier
  in_transit         // On the way
  out_for_delivery   // Last mile
  delivered          // Delivered to customer
  completed          // Customer confirmed/auto-complete after 7 days
  cancelled          // Cancelled
  refunded           // Fully refunded
  partially_refunded // Partially refunded
}

enum ReturnType {
  refund       // Money back
  exchange     // Replace with same/different item
  store_credit // Credit to wallet
}

enum ReturnReason {
  damaged           // Item arrived damaged
  defective         // Item doesn't work as expected
  wrong_item        // Received different item
  not_as_described  // Item doesn't match description
  size_issue        // Wrong size
  quality_issue     // Quality not as expected
  changed_mind      // Customer changed their mind
  other
}

enum ItemCondition {
  unopened     // Still sealed
  like_new     // Opened but unused
  used         // Has been used
  damaged      // Customer damaged it
}

enum ReturnStatus {
  requested         // Customer requested return
  approved          // Return approved
  rejected          // Return rejected
  awaiting_shipment // Waiting for customer to ship
  in_transit        // Customer shipped, on the way
  received          // We received the item
  inspecting        // Checking item condition
  completed         // Return processed, refund issued
  cancelled         // Customer cancelled return request
}

enum DiscountType {
  percentage   // e.g., 20% off
  fixed_amount // e.g., Rp 50,000 off
  free_shipping
}

enum CouponSource {
  manual       // Created manually by admin
  live_deal    // From live commerce session
  campaign     // From marketing campaign
  referral     // From referral program
  loyalty      // From loyalty rewards
  recovery     // Abandoned cart recovery
}
