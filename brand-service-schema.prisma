// =============================================================================
// BRAND SERVICE DATABASE SCHEMA
// Service: brand-service (Port 3005)
// Database: brand_db
// Owner: 15 LAKOO brands, product assignments, brand-specific pricing, live commerce
// =============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("BRAND_DATABASE_URL")
}

// =============================================================================
// BRANDS (15 Official LAKOO Brands)
// =============================================================================

model Brand {
  id                   String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandCode            String      @unique @db.VarChar(50) // LAKOO_ELITE, LAKOO_STREET, etc.
  brandName            String      @db.VarChar(255)
  slug                 String      @unique @db.VarChar(255)
  tagline              String?     @db.VarChar(255)
  brandStory           String?
  // Visual identity
  logoUrl              String?     @db.VarChar(500)
  logoWhiteUrl         String?     @db.VarChar(500)
  bannerUrl            String?     @db.VarChar(500)
  mobileBannerUrl      String?     @db.VarChar(500)
  primaryColor         String?     @default("#000000") @db.VarChar(7)
  secondaryColor       String?     @default("#FFFFFF") @db.VarChar(7)
  accentColor          String?     @db.VarChar(7)
  fontFamily           String?     @db.VarChar(100)
  // Target audience
  targetAudience       String?     @db.VarChar(100) // "Gen Z 18-25", "Professionals 25-35"
  targetGender         String?     @db.VarChar(50)  // "all", "male", "female"
  styleCategory        String?     @db.VarChar(100) // "streetwear", "elegant", "casual"
  priceRange           String?     @db.VarChar(50)  // "budget", "mid", "premium"
  minPrice             Decimal?    @db.Decimal(15, 2)
  maxPrice             Decimal?    @db.Decimal(15, 2)
  // Margin settings
  defaultMarginPercent Decimal?    @default(50.00) @db.Decimal(5, 2)
  minMarginPercent     Decimal?    @default(30.00) @db.Decimal(5, 2)
  // Social links
  instagramHandle      String?     @db.VarChar(100)
  tiktokHandle         String?     @db.VarChar(100)
  // Display settings
  displayOrder         Int         @default(0)
  isLive               Boolean     @default(false) // Currently live streaming?
  featuredProductId    String?     @db.Uuid
  // Status
  status               BrandStatus @default(draft)
  launchedAt           DateTime?   @db.Timestamptz(6)
  // SEO
  metaTitle            String?     @db.VarChar(255)
  metaDescription      String?
  // Audit
  managedBy            String?     @db.Uuid // Brand manager user ID
  createdBy            String?     @db.Uuid
  updatedBy            String?     @db.Uuid
  createdAt            DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt            DateTime    @updatedAt @db.Timestamptz(6)
  deletedAt            DateTime?   @db.Timestamptz(6)

  brandProducts        BrandProduct[]
  collections          BrandCollection[]
  content              BrandContent[]
  liveSessions         LiveSession[]
  banners              BrandBanner[]

  @@index([brandCode])
  @@index([slug])
  @@index([status])
  @@index([deletedAt])
  @@map("brand")
}

// =============================================================================
// BRAND-PRODUCT ASSIGNMENTS (Same product, different brand pricing)
// =============================================================================

model BrandProduct {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandId           String    @db.Uuid
  productId         String    @db.Uuid // Reference to Product Service
  variantId         String?   @db.Uuid // Optional: variant-specific pricing
  // Brand-specific pricing (THIS IS THE KEY DIFFERENTIATOR)
  brandPrice        Decimal   @db.Decimal(15, 2)
  brandComparePrice Decimal?  @db.Decimal(15, 2) // "Was" price for strikethrough
  discountPercent   Decimal?  @db.Decimal(5, 2)
  marginPercent     Decimal?  @db.Decimal(5, 2) // Actual margin achieved
  // Brand-specific presentation
  brandProductName  String?   @db.VarChar(255) // Override product name
  brandDescription  String?
  brandTags         String[]
  // Collection assignment
  collectionId      String?   @db.Uuid
  // Display settings
  displayOrder      Int       @default(0)
  isFeatured        Boolean   @default(false)
  isBestseller      Boolean   @default(false)
  isNewArrival      Boolean   @default(false)
  isOnSale          Boolean   @default(false)
  isExclusive       Boolean   @default(false) // Only available in this brand
  // Visibility
  isActive          Boolean   @default(true)
  publishedAt       DateTime? @db.Timestamptz(6)
  // Dates
  newArrivalUntil   DateTime? @db.Timestamptz(6)
  saleEndsAt        DateTime? @db.Timestamptz(6)
  // Audit
  createdBy         String?   @db.Uuid
  updatedBy         String?   @db.Uuid
  createdAt         DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @db.Timestamptz(6)
  deletedAt         DateTime? @db.Timestamptz(6)

  brand      Brand            @relation(fields: [brandId], references: [id], onDelete: Cascade)
  collection BrandCollection? @relation(fields: [collectionId], references: [id])

  @@unique([brandId, productId, variantId])
  @@index([brandId])
  @@index([productId])
  @@index([collectionId])
  @@index([isFeatured])
  @@index([isActive])
  @@index([deletedAt])
  @@map("brand_product")
}

// =============================================================================
// BRAND COLLECTIONS (Seasonal/thematic groupings)
// =============================================================================

model BrandCollection {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandId         String    @db.Uuid
  name            String    @db.VarChar(255)
  slug            String    @db.VarChar(255)
  description     String?
  imageUrl        String?
  bannerUrl       String?
  season          String?   @db.VarChar(50) // "Spring 2026", "Ramadan 2026"
  displayOrder    Int       @default(0)
  isActive        Boolean   @default(true)
  startsAt        DateTime? @db.Timestamptz(6)
  endsAt          DateTime? @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @db.Timestamptz(6)

  brand    Brand          @relation(fields: [brandId], references: [id], onDelete: Cascade)
  products BrandProduct[]

  @@unique([brandId, slug])
  @@index([brandId])
  @@index([isActive])
  @@map("brand_collection")
}

// =============================================================================
// BRAND CONTENT (Marketing content, lookbooks, etc.)
// =============================================================================

model BrandContent {
  id           String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandId      String      @db.Uuid
  contentType  ContentType
  title        String      @db.VarChar(255)
  slug         String      @db.VarChar(255)
  content      String?
  excerpt      String?     @db.VarChar(500)
  imageUrl     String?
  videoUrl     String?
  ctaText      String?     @db.VarChar(100)
  ctaUrl       String?     @db.VarChar(500)
  displayOrder Int         @default(0)
  isActive     Boolean     @default(true)
  publishedAt  DateTime?   @db.Timestamptz(6)
  createdAt    DateTime    @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime    @updatedAt @db.Timestamptz(6)

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@unique([brandId, slug])
  @@index([brandId])
  @@index([contentType])
  @@map("brand_content")
}

model BrandBanner {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandId      String    @db.Uuid
  placement    String    @db.VarChar(50) // "hero", "category", "sidebar"
  title        String?   @db.VarChar(255)
  subtitle     String?   @db.VarChar(255)
  imageUrl     String
  mobileImageUrl String?
  linkUrl      String?   @db.VarChar(500)
  displayOrder Int       @default(0)
  isActive     Boolean   @default(true)
  startsAt     DateTime? @db.Timestamptz(6)
  endsAt       DateTime? @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @db.Timestamptz(6)
  updatedAt    DateTime  @updatedAt @db.Timestamptz(6)

  brand Brand @relation(fields: [brandId], references: [id], onDelete: Cascade)

  @@index([brandId])
  @@index([placement])
  @@index([isActive])
  @@map("brand_banner")
}

// =============================================================================
// LIVE COMMERCE (Daily live streaming feature)
// =============================================================================

model LiveSession {
  id                String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandId           String           @db.Uuid
  title             String           @db.VarChar(255)
  description       String?
  thumbnailUrl      String?
  // Host info
  hostName          String?          @db.VarChar(255)
  hostImageUrl      String?
  hostType          HostType         @default(internal) // influencer, celebrity, staff
  // Stream info
  streamUrl         String?          @db.VarChar(500)
  streamKey         String?          @db.VarChar(255)
  platform          String?          @db.VarChar(50) // "internal", "instagram", "tiktok"
  // Timing
  scheduledAt       DateTime         @db.Timestamptz(6)
  startedAt         DateTime?        @db.Timestamptz(6)
  endedAt           DateTime?        @db.Timestamptz(6)
  durationMinutes   Int?
  // Status
  status            LiveSessionStatus @default(scheduled)
  // Stats (updated in real-time)
  viewerCount       Int              @default(0)
  peakViewerCount   Int              @default(0)
  totalViews        Int              @default(0)
  likeCount         Int              @default(0)
  commentCount      Int              @default(0)
  orderCount        Int              @default(0)
  totalSales        Decimal          @default(0) @db.Decimal(15, 2)
  // Recording
  recordingUrl      String?          @db.VarChar(500)
  isRecordingPublic Boolean          @default(false)
  createdAt         DateTime         @default(now()) @db.Timestamptz(6)
  updatedAt         DateTime         @updatedAt @db.Timestamptz(6)

  brand    Brand             @relation(fields: [brandId], references: [id], onDelete: Cascade)
  products LiveSessionProduct[]
  deals    LiveDeal[]

  @@index([brandId])
  @@index([status])
  @@index([scheduledAt])
  @@map("live_session")
}

model LiveSessionProduct {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId       String    @db.Uuid
  brandProductId  String    @db.Uuid // Reference to BrandProduct
  productId       String    @db.Uuid // Reference to Product Service
  // Live pricing (can be different from regular brand price)
  livePrice       Decimal   @db.Decimal(15, 2)
  regularPrice    Decimal   @db.Decimal(15, 2)
  stockLimit      Int?      // Limited stock for live deals
  stockSold       Int       @default(0)
  displayOrder    Int       @default(0)
  featuredAt      DateTime? @db.Timestamptz(6) // When product was featured in stream
  createdAt       DateTime  @default(now()) @db.Timestamptz(6)

  session LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([brandProductId])
  @@map("live_session_product")
}

model LiveDeal {
  id              String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sessionId       String    @db.Uuid
  name            String    @db.VarChar(255)
  discountPercent Decimal   @db.Decimal(5, 2)
  couponCode      String?   @db.VarChar(50)
  maxUses         Int?
  usedCount       Int       @default(0)
  startsAt        DateTime  @db.Timestamptz(6)
  endsAt          DateTime  @db.Timestamptz(6)
  isActive        Boolean   @default(true)
  createdAt       DateTime  @default(now()) @db.Timestamptz(6)

  session LiveSession @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@index([sessionId])
  @@index([couponCode])
  @@map("live_deal")
}

// =============================================================================
// BRAND PRICING HISTORY (For analytics)
// =============================================================================

model BrandPricingHistory {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  brandId         String   @db.Uuid
  brandProductId  String   @db.Uuid
  productId       String   @db.Uuid
  oldPrice        Decimal  @db.Decimal(15, 2)
  newPrice        Decimal  @db.Decimal(15, 2)
  changeReason    String?  @db.VarChar(255)
  changedBy       String?  @db.Uuid
  createdAt       DateTime @default(now()) @db.Timestamptz(6)

  @@index([brandId])
  @@index([brandProductId])
  @@index([createdAt])
  @@map("brand_pricing_history")
}

// =============================================================================
// SERVICE OUTBOX (For future Kafka migration)
// =============================================================================

model ServiceOutbox {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @db.VarChar(100)
  aggregateId   String    @db.Uuid
  eventType     String    @db.VarChar(100)
  payload       Json
  metadata      Json?
  isPublished   Boolean   @default(false)
  publishedAt   DateTime? @db.Timestamptz(6)
  retryCount    Int       @default(0)
  lastError     String?
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)

  @@index([isPublished, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("service_outbox")
}

// =============================================================================
// ENUMS
// =============================================================================

enum BrandStatus {
  draft
  active
  inactive
  archived
}

enum ContentType {
  lookbook
  campaign
  blog_post
  style_guide
  announcement
  video
}

enum HostType {
  internal
  influencer
  celebrity
  guest
}

enum LiveSessionStatus {
  scheduled
  live
  ended
  cancelled
}
