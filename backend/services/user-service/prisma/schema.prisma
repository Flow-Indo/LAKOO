// =============================================================================
// AUTH SERVICE DATABASE SCHEMA
// Service: auth-service (Port 8001)
// Database: auth_db
// Owner: User identity, authentication, sessions, tokens
// =============================================================================

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url = env("AUTH_DATABASE_URL")
}

// =============================================================================
// CORE USER IDENTITY
// =============================================================================

model User {
  id              String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String?    @unique @db.VarChar(255)
  phoneNumber     String     @unique @db.VarChar(20)
  passwordHash    String?
  firstName       String?    @db.VarChar(100)
  lastName        String?    @db.VarChar(100)
  profileImageUrl String?
  role            UserRole   @default(buyer)
  status          UserStatus @default(active)
  emailVerified   Boolean    @default(false)
  phoneVerified   Boolean    @default(false)
  lastLoginAt     DateTime?  @db.Timestamptz(6)
  lastLoginIp     String?    @db.VarChar(45)
  failedAttempts  Int        @default(0)
  lockedUntil     DateTime?  @db.Timestamptz(6)
  createdAt       DateTime   @default(now()) @db.Timestamptz(6)
  updatedAt       DateTime   @updatedAt @db.Timestamptz(6)
  deletedAt       DateTime?  @db.Timestamptz(6)

  sessions      UserSession[]
  refreshTokens RefreshToken[]
  otpCodes      OtpVerification[]
  passwordResets PasswordResetToken[]

  @@index([email])
  @@index([phoneNumber])
  @@index([role])
  @@index([status])
  @@index([deletedAt])
  @@map("user")
}

// =============================================================================
// SESSION MANAGEMENT
// =============================================================================

model UserSession {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String    @db.Uuid
  sessionToken String    @unique @db.VarChar(255)
  deviceType   String?   @db.VarChar(50)
  deviceName   String?   @db.VarChar(255)
  browser      String?   @db.VarChar(100)
  os           String?   @db.VarChar(100)
  ipAddress    String?   @db.VarChar(45)
  userAgent    String?
  isActive     Boolean   @default(true)
  lastActiveAt DateTime  @default(now()) @db.Timestamptz(6)
  expiresAt    DateTime  @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([expiresAt])
  @@map("user_session")
}

model RefreshToken {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String    @db.Uuid
  token       String    @unique @db.VarChar(500)
  family      String    @db.VarChar(100) // Token family for rotation
  deviceId    String?   @db.VarChar(255)
  isRevoked   Boolean   @default(false)
  revokedAt   DateTime? @db.Timestamptz(6)
  revokedBy   String?   @db.VarChar(100) // "user", "logout", "security", "rotation"
  expiresAt   DateTime  @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([family])
  @@index([expiresAt])
  @@map("refresh_token")
}

// =============================================================================
// VERIFICATION & PASSWORD RESET
// =============================================================================

model OtpVerification {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String?     @db.Uuid
  identifier  String      @db.VarChar(255) // phone or email
  type        OtpType
  code        String      @db.VarChar(10)
  attempts    Int         @default(0)
  maxAttempts Int         @default(3)
  isUsed      Boolean     @default(false)
  usedAt      DateTime?   @db.Timestamptz(6)
  expiresAt   DateTime    @db.Timestamptz(6)
  createdAt   DateTime    @default(now()) @db.Timestamptz(6)

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([identifier])
  @@index([code])
  @@index([expiresAt])
  @@map("otp_verification")
}

model PasswordResetToken {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @db.Uuid
  token     String    @unique @db.VarChar(255)
  isUsed    Boolean   @default(false)
  usedAt    DateTime? @db.Timestamptz(6)
  expiresAt DateTime  @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_token")
}

// =============================================================================
// AUDIT LOG
// =============================================================================

model AuthAuditLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String?  @db.Uuid
  action     String   @db.VarChar(100) // login, logout, password_change, etc.
  ipAddress  String?  @db.VarChar(45)
  userAgent  String?
  metadata   Json?
  success    Boolean  @default(true)
  failReason String?  @db.VarChar(255)
  createdAt  DateTime @default(now()) @db.Timestamptz(6)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("auth_audit_log")
}

// =============================================================================
// SERVICE OUTBOX (For future Kafka migration)
// =============================================================================

model ServiceOutbox {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @db.VarChar(100) // "user"
  aggregateId   String    @db.Uuid
  eventType     String    @db.VarChar(100) // "user.registered", "user.verified"
  payload       Json
  metadata      Json?
  isPublished   Boolean   @default(false)
  publishedAt   DateTime? @db.Timestamptz(6)
  retryCount    Int       @default(0)
  lastError     String?
  createdAt     DateTime  @default(now()) @db.Timestamptz(6)

  @@index([isPublished, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("service_outbox")
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserRole {
  buyer
  seller
  brand_manager
  warehouse_staff
  cs_agent
  admin
  super_admin
}

enum UserStatus {
  pending_verification
  active
  inactive
  suspended
  banned
}

enum OtpType {
  phone_verification
  email_verification
  login
  password_reset
  transaction
}
