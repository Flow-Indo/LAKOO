// =============================================================================
// AUTH SERVICE DATABASE SCHEMA
// Service: auth-service (Port 8001)
// Database: auth_db
// Owner: User identity, authentication, sessions, tokens
// =============================================================================

generator client {
  provider = "prisma-client-js"
  binaryTargets = ["native", "linux-musl-arm64-openssl-3.0.x"]
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url = env("AUTH_DATABASE_URL")
}

// =============================================================================
// CORE USER IDENTITY
// =============================================================================

model User {
  id              String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  email           String?    @unique @db.VarChar(255)
  phoneNumber     String     @unique @map("phone_number") @db.VarChar(20)
  passwordHash    String?    @map("password_hash")
  firstName       String?    @map("first_name") @db.VarChar(100)
  lastName        String?    @map("last_name") @db.VarChar(100)
  profileImageUrl String?    @map("profile_image_url")
  role            UserRole   @default(buyer)
  status          UserStatus @default(active)
  emailVerified   Boolean    @default(false) @map("email_verified")
  phoneVerified   Boolean    @default(false) @map("phone_verified")
  lastLoginAt     DateTime?  @map("last_login_at") @db.Timestamptz(6)
  lastLoginIp     String?    @map("last_login_ip") @db.VarChar(45)
  failedAttempts  Int        @default(0) @map("failed_attempts")
  lockedUntil     DateTime?  @map("locked_until") @db.Timestamptz(6)
  createdAt       DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt       DateTime?  @map("deleted_at") @db.Timestamptz(6)

  sessions      UserSession[]
  refreshTokens RefreshToken[]
  otpCodes      OtpVerification[]
  passwordResets PasswordResetToken[]

  @@index([email])
  @@index([phoneNumber])
  @@index([role])
  @@index([status])
  @@index([deletedAt])
  @@map("user")
}

// =============================================================================
// SESSION MANAGEMENT
// =============================================================================

model UserSession {
  id           String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId       String    @map("user_id") @db.Uuid
  sessionToken String    @unique @map("session_token") @db.VarChar(255)
  deviceType   String?   @map("device_type") @db.VarChar(50)
  deviceName   String?   @map("device_name") @db.VarChar(255)
  browser      String?   @db.VarChar(100)
  os           String?   @db.VarChar(100)
  ipAddress    String?   @map("ip_address") @db.VarChar(45)
  userAgent    String?   @map("user_agent")
  isActive     Boolean   @default(true) @map("is_active")
  lastActiveAt DateTime  @default(now()) @map("last_active_at") @db.Timestamptz(6)
  expiresAt    DateTime  @map("expires_at") @db.Timestamptz(6)
  createdAt    DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([sessionToken])
  @@index([expiresAt])
  @@map("user_session")
}

model RefreshToken {
  id          String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String    @map("user_id") @db.Uuid
  token       String    @unique @db.VarChar(500)
  family      String    @db.VarChar(100) // Token family for rotation
  deviceId    String?   @map("device_id") @db.VarChar(255)
  isRevoked   Boolean   @default(false) @map("is_revoked")
  revokedAt   DateTime? @map("revoked_at") @db.Timestamptz(6)
  revokedBy   String?   @map("revoked_by") @db.VarChar(100) // "user", "logout", "security", "rotation"
  expiresAt   DateTime  @map("expires_at") @db.Timestamptz(6)
  createdAt   DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([family])
  @@index([expiresAt])
  @@map("refresh_token")
}

// =============================================================================
// VERIFICATION & PASSWORD RESET
// =============================================================================

model OtpVerification {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId      String?     @map("user_id") @db.Uuid
  identifier  String      @db.VarChar(255) // phone or email
  type        OtpType
  code        String      @db.VarChar(10)
  attempts    Int         @default(0)
  maxAttempts Int         @default(3) @map("max_attempts")
  isUsed      Boolean     @default(false) @map("is_used")
  usedAt      DateTime?   @map("used_at") @db.Timestamptz(6)
  expiresAt   DateTime    @map("expires_at") @db.Timestamptz(6)
  createdAt   DateTime    @default(now()) @map("created_at") @db.Timestamptz(6)

  user User? @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([identifier])
  @@index([code])
  @@index([expiresAt])
  @@map("otp_verification")
}

model PasswordResetToken {
  id        String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  token     String    @unique @db.VarChar(255)
  isUsed    Boolean   @default(false) @map("is_used")
  usedAt    DateTime? @map("used_at") @db.Timestamptz(6)
  expiresAt DateTime  @map("expires_at") @db.Timestamptz(6)
  createdAt DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
  @@map("password_reset_token")
}

// =============================================================================
// AUDIT LOG
// =============================================================================

model AuthAuditLog {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId     String?  @map("user_id") @db.Uuid
  action     String   @db.VarChar(100) // login, logout, password_change, etc.
  ipAddress  String?  @map("ip_address") @db.VarChar(45)
  userAgent  String?  @map("user_agent")
  metadata   Json?
  success    Boolean  @default(true)
  failReason String?  @map("fail_reason") @db.VarChar(255)
  createdAt  DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([userId])
  @@index([action])
  @@index([createdAt])
  @@map("auth_audit_log")
}

// =============================================================================
// SERVICE OUTBOX (For future Kafka migration)
// =============================================================================

model ServiceOutbox {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @map("aggregate_type") @db.VarChar(100) // "user"
  aggregateId   String    @map("aggregate_id") @db.Uuid
  eventType     String    @map("event_type") @db.VarChar(100) // "user.registered", "user.verified"
  payload       Json
  metadata      Json?
  isPublished   Boolean   @default(false) @map("is_published")
  publishedAt   DateTime? @map("published_at") @db.Timestamptz(6)
  retryCount    Int       @default(0) @map("retry_count")
  lastError     String?   @map("last_error")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([isPublished, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("service_outbox")
}

// =============================================================================
// ENUMS
// =============================================================================

enum UserRole {
  buyer
  seller
  brand_manager
  warehouse_staff
  cs_agent
  admin
  super_admin
}

enum UserStatus {
  pending_verification
  active
  inactive
  suspended
  banned
}

enum OtpType {
  phone_verification
  email_verification
  login
  password_reset
  transaction
}
