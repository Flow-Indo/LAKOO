// =============================================================================
// LOGISTICS SERVICE DATABASE SCHEMA
// Service: logistics-service (Port 3009)
// Database: logistics_db
// Owner: Shipments, tracking events, courier integrations, shipping rates
// =============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("LOGISTICS_DATABASE_URL")
}

// =============================================================================
// SHIPMENTS
// =============================================================================

model Shipment {
  id                  String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shipmentNumber      String         @unique @map("shipment_number") 
  orderId             String         @map("order_id")
  returnId            String?        @map("return_id")
  userId              String         @map("user_id")
  // Courier info (Biteship integration)
  courier             String         @map("courier")
  courierName         String?        @map("courier_name")
  serviceType         String?        @map("service_type")
  serviceName         String?        @map("service_name")
  trackingNumber      String?        @map("tracking_number")
  waybillId           String?        @map("waybill_id")
  // Shipping details
  shippingCost        Decimal        @map("shipping_cost")
  insuranceCost       Decimal        @default(0) @map("insurance_cost")
  codAmount           Decimal        @default(0) @map("cod_amount") 
  totalCost           Decimal        @map("total_cost")
  // Package info
  weightGrams         Int            @map("weight_grams")
  lengthCm            Decimal?       @map("length_cm")
  widthCm             Decimal?       @map("width_cm")
  heightCm            Decimal?       @map("height_cm")
  itemCount           Int            @default(1) @map("item_count")
  itemDescription     String?        @map("item_description")
  // Origin address (warehouse)
  originName          String         @map("origin_name")
  originPhone         String         @map("origin_phone")
  originAddress       String         @map("origin_address")
  originDistrict      String?        @map("origin_district")
  originCity          String         @map("origin_city")
  originProvince      String         @map("origin_province")
  originPostalCode    String         @map("origin_postal_code")
  originLatitude      Decimal?       @map("origin_latitude")
  originLongitude     Decimal?       @map("origin_longitude")
  // Destination address
  destName            String         @map("dest_name")
  destPhone           String         @map("dest_phone")
  destAddress         String         @map("dest_address")
  destDistrict        String?        @map("dest_district")
  destCity            String         @map("dest_city")
  destProvince        String         @map("dest_province")
  destPostalCode      String         @map("dest_postal_code")
  destLatitude        Decimal?       @map("dest_latitude")
  destLongitude       Decimal?       @map("dest_longitude")
  // Timestamps
  estimatedDelivery   DateTime?      @map("estimated_delivery")
  bookedAt            DateTime?      @map("booked_at")
  pickedUpAt          DateTime?      @map("picked_up_at")
  inTransitAt         DateTime?      @map("in_transit_at")
  outForDeliveryAt    DateTime?      @map("out_for_delivery_at")
  deliveredAt         DateTime?      @map("delivered_at")
  failedAt            DateTime?      @map("failed_at")
  returnedAt          DateTime?      @map("returned_at")
  // Status
  status              ShipmentStatus @default(pending)
  failureReason       String?        @map("failure_reason")
  // Delivery confirmation
  receiverName        String?        @map("receiver_name")
  proofOfDeliveryUrl  String?        @map("proof_of_delivery_url")
  signature           String?        @map("signature")
  // Notes
  instructions        String?        @map("instructions")
  internalNotes       String?        @map("internal_notes")
  // Metadata
  biteshipOrderId     String?        @map("biteship_order_id")
  metadata            Json?
  createdAt           DateTime       @default(now()) @map("created_at")
  updatedAt           DateTime       @updatedAt @map("updated_at")

  trackingEvents TrackingEvent[]

  @@index([shipmentNumber])
  @@index([orderId])
  @@index([trackingNumber])
  @@index([status])
  @@index([createdAt])
  @@map("shipment")
}

// =============================================================================
// TRACKING EVENTS
// =============================================================================

model TrackingEvent {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  shipmentId    String    @map("shipment_id")
  // Event info
  status        String    @map("status")
  statusCode    String?   @map("status_code")
  description   String?   @map("description")
  location      String?   @map("location")
  city          String?   @map("city")
  // Courier info
  courierStatus String?   @map("courier_status")
  // Timestamp from courier
  eventTime     DateTime  @map("event_time")
  // Source
  source        String    @default("webhook") @map("source")
  rawPayload    Json?
  createdAt     DateTime  @default(now()) @map("created_at")

  shipment Shipment @relation(fields: [shipmentId], references: [id], onDelete: Cascade)

  @@index([shipmentId])
  @@index([eventTime])
  @@map("tracking_event")
}

// =============================================================================
// COURIER INTEGRATION CONFIG
// =============================================================================

model CourierIntegration {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  courierCode     String   @unique @map("courier_code")
  courierName     String   @map("courier_name")
  isActive        Boolean  @default(true) @map("is_active")
  // API config (encrypted in practice)
  apiEndpoint     String?  @map("api_endpoint")
  apiKey          String?  @map("api_key")
  // Features
  supportsCod     Boolean  @default(false) @map("supports_cod")
  supportsInsurance Boolean @default(true) @map("supports_insurance")
  supportsPickup  Boolean  @default(true) @map("supports_pickup")
  supportsDropoff Boolean  @default(true) @map("supports_dropoff")
  supportsRealTimeTracking Boolean @default(true) @map("supports_real_time_tracking")
  // Rate calculation
  hasFixedRates   Boolean  @default(false) @map("has_fixed_rates")
  rateMultiplier  Decimal  @default(1.00) @db.Decimal(5, 2) // For markup
  // Display
  logoUrl         String?  @map("logo_url")
  displayOrder    Int      @default(0) @map("display_order")
  // Cutoff times
  pickupCutoffTime String?  @map("pickup_cutoff_time")
  // Settings
  settings        Json?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  services CourierService[]

  @@map("courier_integration")
}

model CourierService {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  courierId       String   @map("courier_id")
  serviceCode     String   @map("service_code")
  serviceName     String   @map("service_name")
  serviceType     String?  @map("service_type")
  estimatedDays   String?  @map("estimated_days")
  isActive        Boolean  @default(true) @map("is_active")
  displayOrder    Int      @default(0) @map("display_order")
  createdAt       DateTime @default(now()) @map("created_at")

  courier CourierIntegration @relation(fields: [courierId], references: [id], onDelete: Cascade)

  @@unique([courierId, serviceCode])
  @@map("courier_service")
}

// =============================================================================
// SHIPPING RATE CACHE
// =============================================================================

model ShippingRateCache {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  originPostalCode String  @map("origin_postal_code")
  destPostalCode  String   @map("dest_postal_code")
  weightGrams     Int      @map("weight_grams")
  courier         String   @map("courier")
  serviceCode     String   @map("service_code")
  // Cached rate
  rate            Decimal  @map("rate")
  estimatedDays   String?  @map("estimated_days")
  // Validity
  expiresAt       DateTime @map("expires_at")
  createdAt       DateTime @default(now()) @map("created_at")

  @@unique([originPostalCode, destPostalCode, weightGrams, courier, serviceCode])
  @@index([expiresAt])
  @@map("shipping_rate_cache")
}

// =============================================================================
// WAREHOUSE LOCATION (For origin addresses)
// =============================================================================

model WarehouseLocation {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code          String   @unique @map("code")
  name          String   @map("name")
  contactName   String   @map("contact_name")
  contactPhone  String   @map("contact_phone")
  address       String   @map("address")
  district      String?  @map("district")
  city          String   @map("city")
  province      String   @map("province")
  postalCode    String   @map("postal_code")
  latitude      Decimal? @map("latitude")
  longitude     Decimal? @map("longitude")
  isDefault     Boolean  @default(false) @map("is_default")
  isActive      Boolean  @default(true) @map("is_active")
  operatingHours String?  @map("operating_hours")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  @@map("warehouse_location")
}

// =============================================================================
// SERVICE OUTBOX (For future Kafka migration)
// =============================================================================

model ServiceOutbox {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @map("aggregate_type")
  aggregateId   String    @map("aggregate_id")
  eventType     String    @map("event_type")
  payload       Json      @map("payload")
  metadata      Json?     @map("metadata")
  isPublished   Boolean   @default(false) @map("is_published")
  publishedAt   DateTime? @map("published_at")
  retryCount    Int       @default(0) @map("retry_count")
  lastError     String?   @map("last_error")
  createdAt     DateTime  @default(now()) @map("created_at")

  @@index([isPublished, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("service_outbox")
}

// =============================================================================
// ENUMS
// =============================================================================

enum ShipmentStatus {
  pending           // Shipment created, not yet booked
  booked            // Booked with courier
  awaiting_pickup   // Waiting for courier pickup
  picked_up         // Courier picked up
  in_transit        // On the way
  at_destination_hub // Arrived at destination city
  out_for_delivery  // Last mile delivery
  delivered         // Successfully delivered
  failed            // Delivery failed
  returned          // Returned to sender
  cancelled         // Cancelled before pickup
}
