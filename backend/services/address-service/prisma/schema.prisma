// =============================================================================
// ADDRESS SERVICE DATABASE SCHEMA
// Service: address-service (Port 3010)
// Database: address_db
// Owner: User addresses, address validation, Indonesian location data
// =============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("ADDRESS_DATABASE_URL")
}

// =============================================================================
// USER ADDRESSES
// =============================================================================

model Address {
  id             String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId         String    @map("user_id") @db.Uuid // Reference to Auth Service
  label          String?   @db.VarChar(50) // "Home", "Office", "Apartment"
  // Recipient info (can differ from user)
  recipientName  String    @map("recipient_name") @db.VarChar(255)
  phoneNumber    String    @map("phone_number") @db.VarChar(20)
  alternatePhone String?   @map("alternate_phone") @db.VarChar(20)
  // Address details
  streetAddress  String    @map("street_address")
  addressLine2   String?   @map("address_line_2") @db.VarChar(255) // Apartment, suite, unit, etc.
  rt             String?   @db.VarChar(10)  // Indonesian RT
  rw             String?   @db.VarChar(10)  // Indonesian RW
  // Location hierarchy
  villageId      String?   @map("village_id") @db.Uuid
  villageName    String?   @map("village_name") @db.VarChar(100)
  districtId     String?   @map("district_id") @db.Uuid
  districtName   String?   @map("district_name") @db.VarChar(100) // Kecamatan
  cityId         String?   @map("city_id") @db.Uuid
  cityName       String    @map("city_name") @db.VarChar(100) // Kota/Kabupaten
  provinceId     String?   @map("province_id") @db.Uuid
  provinceName   String    @map("province_name") @db.VarChar(100)
  postalCode     String    @map("postal_code") @db.VarChar(10)
  country        String    @default("Indonesia") @db.VarChar(100)
  countryCode    String    @default("ID") @map("country_code") @db.VarChar(2)
  // Coordinates (for delivery optimization)
  latitude       Decimal?  @db.Decimal(10, 8)
  longitude      Decimal?  @db.Decimal(11, 8)
  geoAccuracy    String?   @map("geo_accuracy") @db.VarChar(50) // "exact", "approximate", "postal_code"
  // Courier-specific codes
  biteshipAreaId String?   @map("biteship_area_id") @db.VarChar(50)
  jneAreaCode    String?   @map("jne_area_code") @db.VarChar(50)
  jntAreaCode    String?   @map("jnt_area_code") @db.VarChar(50)
  // Settings
  isDefault      Boolean   @default(false) @map("is_default")
  isValidated    Boolean   @default(false) @map("is_validated")
  validatedAt    DateTime? @map("validated_at") @db.Timestamptz(6)
  // Delivery notes
  deliveryNotes  String?   @map("delivery_notes") @db.VarChar(500)
  landmark       String?   @db.VarChar(255) // "Near the mosque", "Behind mall"
  // Usage tracking
  lastUsedAt     DateTime? @map("last_used_at") @db.Timestamptz(6)
  useCount       Int       @default(0) @map("use_count")
  // Audit
  createdAt      DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt      DateTime? @map("deleted_at") @db.Timestamptz(6)

  @@index([userId], map: "address_user_id_idx")
  @@index([cityId], map: "address_city_id_idx")
  @@index([postalCode], map: "address_postal_code_idx")
  @@index([isDefault], map: "address_is_default_idx")
  @@index([deletedAt], map: "address_deleted_at_idx")
  @@map("address")
}

// =============================================================================
// INDONESIAN LOCATION DATA (Static reference data)
// =============================================================================

model Province {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  code        String   @unique @db.VarChar(10) // BPS code
  name        String   @db.VarChar(100)
  altNames    String[] @map("alt_names") // Alternative names
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  cities City[]

  @@index([name], map: "province_name_idx")
  @@map("province")
}

model City {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  provinceId  String   @map("province_id") @db.Uuid
  code        String   @unique @db.VarChar(10) // BPS code
  name        String   @db.VarChar(100)
  type        CityType // Kota or Kabupaten
  altNames    String[] @map("alt_names")
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  province  Province   @relation(fields: [provinceId], references: [id])
  districts District[]

  @@index([provinceId], map: "city_province_id_idx")
  @@index([name], map: "city_name_idx")
  @@map("city")
}

model District {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  cityId      String   @map("city_id") @db.Uuid
  code        String   @unique @db.VarChar(10) // BPS code
  name        String   @db.VarChar(100) // Kecamatan name
  altNames    String[] @map("alt_names")
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  city     City      @relation(fields: [cityId], references: [id])
  villages Village[]

  @@index([cityId], map: "district_city_id_idx")
  @@index([name], map: "district_name_idx")
  @@map("district")
}

model Village {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  districtId  String   @map("district_id") @db.Uuid
  code        String   @unique @db.VarChar(15) // BPS code
  name        String   @db.VarChar(100) // Kelurahan/Desa name
  type        VillageType // Kelurahan or Desa
  postalCode  String?  @map("postal_code") @db.VarChar(10)
  altNames    String[] @map("alt_names")
  latitude    Decimal? @db.Decimal(10, 8)
  longitude   Decimal? @db.Decimal(11, 8)
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  district District @relation(fields: [districtId], references: [id])

  @@index([districtId], map: "village_district_id_idx")
  @@index([postalCode], map: "village_postal_code_idx")
  @@index([name], map: "village_name_idx")
  @@map("village")
}

// =============================================================================
// POSTAL CODE DATA
// =============================================================================

model PostalCode {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  postalCode     String   @map("postal_code") @db.VarChar(10)
  villageName    String?  @map("village_name") @db.VarChar(100)
  districtName   String?  @map("district_name") @db.VarChar(100)
  cityName       String   @map("city_name") @db.VarChar(100)
  provinceName   String   @map("province_name") @db.VarChar(100)
  latitude       Decimal? @db.Decimal(10, 8)
  longitude      Decimal? @db.Decimal(11, 8)
  // Courier area codes
  biteshipAreaId String?  @map("biteship_area_id") @db.VarChar(50)
  createdAt      DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  @@unique([postalCode, villageName], map: "postal_code_postal_code_village_name_key")
  @@index([postalCode], map: "postal_code_postal_code_idx")
  @@index([cityName], map: "postal_code_city_name_idx")
  @@map("postal_code")
}

// =============================================================================
// ADDRESS VALIDATION CACHE
// =============================================================================

model AddressValidationCache {
  id                  String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  addressHash         String    @unique @map("address_hash") @db.VarChar(64) // SHA256 of address components
  // Input
  inputAddress        String    @map("input_address")
  inputCity           String    @map("input_city") @db.VarChar(100)
  inputPostalCode     String    @map("input_postal_code") @db.VarChar(10)
  // Validated output
  isValid             Boolean   @map("is_valid")
  validatedAddress    String?   @map("validated_address")
  validatedCity       String?   @map("validated_city") @db.VarChar(100)
  validatedProvince   String?   @map("validated_province") @db.VarChar(100)
  validatedPostalCode String?   @map("validated_postal_code") @db.VarChar(10)
  latitude            Decimal?  @db.Decimal(10, 8)
  longitude           Decimal?  @db.Decimal(11, 8)
  confidence          Decimal?  @db.Decimal(5, 2) // 0-100
  // Courier compatibility
  biteshipAreaId      String?   @map("biteship_area_id") @db.VarChar(50)
  // Metadata
  validationSource    String?   @map("validation_source") @db.VarChar(50) // "biteship", "google", "internal"
  expiresAt           DateTime  @map("expires_at") @db.Timestamptz(6)
  createdAt           DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([addressHash], map: "address_validation_cache_address_hash_idx")
  @@index([expiresAt], map: "address_validation_cache_expires_at_idx")
  @@map("address_validation_cache")
}

// =============================================================================
// SERVICE OUTBOX (For future Kafka migration)
// =============================================================================

model ServiceOutbox {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @map("aggregate_type") @db.VarChar(100)
  aggregateId   String    @map("aggregate_id") @db.Uuid
  eventType     String    @map("event_type") @db.VarChar(100)
  payload       Json
  metadata      Json?
  isPublished   Boolean   @default(false) @map("is_published")
  publishedAt   DateTime? @map("published_at") @db.Timestamptz(6)
  retryCount    Int       @default(0) @map("retry_count")
  lastError     String?   @map("last_error")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([isPublished, createdAt], map: "service_outbox_is_published_created_at_idx")
  @@index([aggregateType, aggregateId], map: "service_outbox_aggregate_type_aggregate_id_idx")
  @@map("service_outbox")
}

// =============================================================================
// ENUMS
// =============================================================================

enum CityType {
  kota      // City
  kabupaten // Regency
}

enum VillageType {
  kelurahan // Urban village
  desa      // Rural village
}
