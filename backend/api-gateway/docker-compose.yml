services:
  api-gateway:
    build:
      context: ../..
      dockerfile: backend/api-gateway/Dockerfile
    container_name: api-gateway
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NODE_ENV=production
      - API_GATEWAY_PORT=3000
      - GATEWAY_SECRET=${GATEWAY_SECRET:-dev-gateway-secret}
      - SERVICE_SECRET=${SERVICE_SECRET:-dev-service-secret}
      # Local Docker Desktop time drift can happen; allow larger skew for the test token endpoint.
      - SERVICE_AUTH_MAX_SKEW_SECONDS=${SERVICE_AUTH_MAX_SKEW_SECONDS:-86400}
      # Fail fast when an upstream service is unreachable.
      - GATEWAY_PROXY_TIMEOUT_MS=${GATEWAY_PROXY_TIMEOUT_MS:-30000}
      # Enable to log proxied request status/duration.
      - GATEWAY_LOG_REQUESTS=${GATEWAY_LOG_REQUESTS:-false}
      - JWT_SECRET=${JWT_SECRET:-dev-jwt-secret}
      - ENABLE_TEST_TOKEN_ENDPOINT=true
      - DISABLE_BLACKLIST=true
      - BLACKLIST_STRICT=false
      - CART_SERVICE_URL=${CART_SERVICE_URL:-http://cart-service:3003}
      - AUTH_SERVICE_URL=${AUTH_SERVICE_URL:-http://auth-service:3001}
      - ORDER_SERVICE_URL=${ORDER_SERVICE_URL:-http://order-service:3006}
      - PRODUCT_SERVICE_URL=${PRODUCT_SERVICE_URL:-http://product-service:3002}
      - PAYMENT_SERVICE_URL=${PAYMENT_SERVICE_URL:-http://payment-service:3007}
      - ADDRESS_SERVICE_URL=${ADDRESS_SERVICE_URL:-http://address-service:3010}
      - LOGISTIC_SERVICE_URL=${LOGISTIC_SERVICE_URL:-http://logistic-service:3009}
    networks:
      - shared-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

networks:
  shared-network:
    external: true
    name: microservices-network
