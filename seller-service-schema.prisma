// =============================================================================
// SELLER SERVICE DATABASE SCHEMA
// Service: seller-service (Port 3015)
// Database: seller_db
// Owner: Seller accounts, store page, inventory, payouts, verification
// =============================================================================

generator client {
  provider = "prisma-client-js"
  output   = "../generated/client"
}

datasource db {
  provider = "postgresql"
  url      = env("SELLER_DATABASE_URL")
}

// =============================================================================
// SELLERS
// =============================================================================

model Seller {
  id                  String             @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  userId              String             @unique @map("user_id") @db.Uuid // Reference to Auth Service
  sellerCode          String             @unique @map("seller_code") @db.VarChar(50) // SLR-XXXXX
  // Shop info
  shopName            String             @map("shop_name") @db.VarChar(255)
  shopSlug            String             @unique @map("shop_slug") @db.VarChar(255)
  shopDescription     String?            @map("shop_description")
  shopLogoUrl         String?            @map("shop_logo_url")
  shopBannerUrl       String?            @map("shop_banner_url")
  shopAnnouncement    String?            @map("shop_announcement") @db.VarChar(500)
  // Business info
  businessName        String?            @map("business_name") @db.VarChar(255)
  businessType        BusinessType       @default(individual) @map("business_type")
  businessLicense     String?            @map("business_license") @db.VarChar(100)
  taxId               String?            @map("tax_id") @db.VarChar(100) // NPWP
  // Contact
  contactName         String             @map("contact_name") @db.VarChar(255)
  contactEmail        String             @map("contact_email") @db.VarChar(255)
  contactPhone        String             @map("contact_phone") @db.VarChar(20)
  contactWhatsapp     String?            @map("contact_whatsapp") @db.VarChar(20)
  // Address (for pickup)
  address             String?
  district            String?            @db.VarChar(100)
  city                String?            @db.VarChar(100)
  province            String?            @db.VarChar(100)
  postalCode          String?            @map("postal_code") @db.VarChar(10)
  // Bank details (for payouts)
  bankName            String?            @map("bank_name") @db.VarChar(100)
  bankAccountName     String?            @map("bank_account_name") @db.VarChar(255)
  bankAccountNumber   String?            @map("bank_account_number") @db.VarChar(50)
  bankBranch          String?            @map("bank_branch") @db.VarChar(100)
  // Commission rate as decimal (0.0050 = 0.5% for LAKOO social commerce)
  commissionRate      Decimal            @default(0.0050) @map("commission_rate") @db.Decimal(5, 4)
  // Performance metrics
  totalProducts       Int                @default(0) @map("total_products")
  totalOrders         Int                @default(0) @map("total_orders")
  totalRevenue        Decimal            @default(0) @map("total_revenue") @db.Decimal(15, 2)
  avgRating           Decimal?           @map("avg_rating") @db.Decimal(3, 2)
  reviewCount         Int                @default(0) @map("review_count")
  responseRate        Decimal?           @map("response_rate") @db.Decimal(5, 2) // Chat response rate
  responseTime        Int?               @map("response_time") // Avg response time in minutes
  // Badges/achievements
  badges              String[]
  isFeatured          Boolean            @default(false) @map("is_featured")
  // Verification
  verificationStatus  VerificationStatus @default(pending) @map("verification_status")
  verifiedAt          DateTime?          @map("verified_at") @db.Timestamptz(6)
  verifiedBy          String?            @map("verified_by") @db.Uuid
  // Status
  status              SellerStatus       @default(pending)
  suspendedAt         DateTime?          @map("suspended_at") @db.Timestamptz(6)
  suspendReason       String?            @map("suspend_reason") @db.VarChar(500)
  // Settings
  autoAcceptOrders    Boolean            @default(true) @map("auto_accept_orders")
  vacationMode        Boolean            @default(false) @map("vacation_mode")
  vacationMessage     String?            @map("vacation_message") @db.VarChar(500)
  vacationUntil       DateTime?          @map("vacation_until") @db.Timestamptz(6)
  // Audit
  createdAt           DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt           DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)
  deletedAt           DateTime?          @map("deleted_at") @db.Timestamptz(6)

  documents           SellerDocument[]
  payouts             SellerPayout[]
  payoutSchedules     SellerPayoutSchedule[]
  storePage           SellerStorePage?

  @@index([sellerCode])
  @@index([shopSlug])
  @@index([status])
  @@index([verificationStatus])
  @@index([deletedAt])
  @@map("seller")
}

// =============================================================================
// SELLER VERIFICATION DOCUMENTS
// =============================================================================

model SellerDocument {
  id              String         @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sellerId        String         @map("seller_id") @db.Uuid
  documentType    SellerDocType  @map("document_type")
  documentNumber  String?        @map("document_number") @db.VarChar(100)
  fileUrl         String         @map("file_url")
  fileName        String         @map("file_name") @db.VarChar(255)
  fileSize        Int?           @map("file_size")
  // Verification
  status          DocStatus      @default(pending)
  verifiedAt      DateTime?      @map("verified_at") @db.Timestamptz(6)
  verifiedBy      String?        @map("verified_by") @db.Uuid
  rejectedAt      DateTime?      @map("rejected_at") @db.Timestamptz(6)
  rejectionReason String?        @map("rejection_reason") @db.VarChar(500)
  // Expiry
  expiresAt       DateTime?      @map("expires_at") @db.Timestamptz(6)
  createdAt       DateTime       @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime       @updatedAt @map("updated_at") @db.Timestamptz(6)

  seller Seller @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([sellerId])
  @@index([documentType])
  @@index([status])
  @@map("seller_document")
}

// =============================================================================
// SELLER STORE PAGE (Taobao-style store builder)
// =============================================================================

model SellerStorePage {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sellerId        String   @unique @map("seller_id") @db.Uuid
  // Page layout (JSON block-based layout like Taobao store builder)
  // Blocks: hero_banner, image_carousel, product_grid, product_list, text_block, divider, video, collection_link, etc.
  layoutBlocks    Json     @default(dbgenerated("'[]'::jsonb")) @map("layout_blocks") // [{type, config, order}]
  // Draft layout (for editing without affecting live page)
  draftLayoutBlocks Json?  @map("draft_layout_blocks") // Edited version before publishing
  // Theme customization
  primaryColor    String?  @map("primary_color") @db.VarChar(7)  // Hex color
  secondaryColor  String?  @map("secondary_color") @db.VarChar(7)
  fontFamily      String?  @map("font_family") @db.VarChar(100)
  // Draft theme (for editing)
  draftPrimaryColor   String?  @map("draft_primary_color") @db.VarChar(7)
  draftSecondaryColor String?  @map("draft_secondary_color") @db.VarChar(7)
  draftFontFamily     String?  @map("draft_font_family") @db.VarChar(100)
  // Custom content
  customCss       String?  @map("custom_css") // Advanced users
  draftCustomCss  String?  @map("draft_custom_css")
  // Status
  isPublished     Boolean  @default(false) @map("is_published")
  hasDraftChanges Boolean  @default(false) @map("has_draft_changes")
  publishedAt     DateTime? @map("published_at") @db.Timestamptz(6)
  // Audit
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  seller Seller @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@map("seller_store_page")
}

// =============================================================================
// SELLER INVENTORY
// =============================================================================

model SellerInventory {
  id                String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sellerId          String    @map("seller_id") @db.Uuid
  // References Product Service IDs (product_db), not a local seller_product table.
  productId         String    @map("product_id") @db.Uuid
  variantId         String?   @map("variant_id") @db.Uuid
  // Quantities
  quantity          Int       @default(0)
  reservedQuantity  Int       @default(0) @map("reserved_quantity")
  availableQuantity Int       @default(0) @map("available_quantity")
  // Location
  location          String?   @db.VarChar(100)
  // Tracking
  lastRestockedAt   DateTime? @map("last_restocked_at") @db.Timestamptz(6)
  lastSoldAt        DateTime? @map("last_sold_at") @db.Timestamptz(6)
  // Version for optimistic locking
  version           Int       @default(0)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([sellerId, productId, variantId])
  @@index([sellerId])
  @@index([productId])
  @@map("seller_inventory")
}

// =============================================================================
// SELLER PAYOUTS
// =============================================================================

model SellerPayout {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sellerId        String       @map("seller_id") @db.Uuid
  payoutNumber    String       @unique @map("payout_number") @db.VarChar(50) // PAY-20260115-XXXXX
  // Period
  periodStart     DateTime     @map("period_start") @db.Date
  periodEnd       DateTime     @map("period_end") @db.Date
  // Amounts
  grossAmount     Decimal      @map("gross_amount") @db.Decimal(15, 2) // Total sales
  commissionAmount Decimal     @default(0) @map("commission_amount") @db.Decimal(15, 2) // Commission (0% for LAKOO)
  adjustmentAmount Decimal     @default(0) @map("adjustment_amount") @db.Decimal(15, 2) // Returns, chargebacks, etc.
  netAmount       Decimal      @map("net_amount") @db.Decimal(15, 2) // Final payout amount
  // Order summary
  orderCount      Int          @map("order_count")
  itemCount       Int          @map("item_count")
  // Bank details snapshot
  bankName        String       @map("bank_name") @db.VarChar(100)
  bankAccountName String       @map("bank_account_name") @db.VarChar(255)
  bankAccountNumber String     @map("bank_account_number") @db.VarChar(50)
  // Status
  status          PayoutStatus @default(pending)
  approvedAt      DateTime?    @map("approved_at") @db.Timestamptz(6)
  approvedBy      String?      @map("approved_by") @db.Uuid
  processedAt     DateTime?    @map("processed_at") @db.Timestamptz(6)
  paidAt          DateTime?    @map("paid_at") @db.Timestamptz(6)
  rejectedAt      DateTime?    @map("rejected_at") @db.Timestamptz(6)
  rejectionReason String?      @map("rejection_reason") @db.VarChar(500)
  // Transfer reference
  transferReference String?    @map("transfer_reference") @db.VarChar(255)
  transferProofUrl String?     @map("transfer_proof_url")
  // Notes
  notes           String?
  internalNotes   String?      @map("internal_notes")
  createdAt       DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime     @updatedAt @map("updated_at") @db.Timestamptz(6)

  seller Seller           @relation(fields: [sellerId], references: [id])
  items  SellerPayoutItem[]

  @@index([sellerId])
  @@index([payoutNumber])
  @@index([status])
  @@index([periodStart, periodEnd])
  @@map("seller_payout")
}

model SellerPayoutItem {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  payoutId    String   @map("payout_id") @db.Uuid
  orderId     String   @map("order_id") @db.Uuid
  orderNumber String   @map("order_number") @db.VarChar(50)
  orderDate   DateTime @map("order_date") @db.Timestamptz(6)
  grossAmount Decimal  @map("gross_amount") @db.Decimal(15, 2)
  commission  Decimal  @default(0) @db.Decimal(15, 2)
  netAmount   Decimal  @map("net_amount") @db.Decimal(15, 2)
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  payout SellerPayout @relation(fields: [payoutId], references: [id], onDelete: Cascade)

  @@index([payoutId])
  @@index([orderId])
  @@map("seller_payout_item")
}

model SellerPayoutSchedule {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sellerId        String   @map("seller_id") @db.Uuid
  // Schedule type
  frequency       PayoutFrequency @default(weekly)
  dayOfWeek       Int?     @map("day_of_week") // 0-6 for weekly
  dayOfMonth      Int?     @map("day_of_month") // 1-31 for monthly
  // Minimum amount
  minPayoutAmount Decimal  @default(50000) @map("min_payout_amount") @db.Decimal(15, 2) // Min Rp 50,000
  // Status
  isActive        Boolean  @default(true) @map("is_active")
  nextPayoutDate  DateTime? @map("next_payout_date") @db.Date
  lastPayoutDate  DateTime? @map("last_payout_date") @db.Date
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  seller Seller @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@unique([sellerId])
  @@map("seller_payout_schedule")
}

// =============================================================================
// SELLER ANALYTICS (Daily aggregated stats)
// =============================================================================

model SellerDailyStat {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  sellerId        String   @map("seller_id") @db.Uuid
  date            DateTime @db.Date
  // Traffic
  pageViews       Int      @default(0) @map("page_views")
  uniqueVisitors  Int      @default(0) @map("unique_visitors")
  productViews    Int      @default(0) @map("product_views")
  // Conversion
  addToCartCount  Int      @default(0) @map("add_to_cart_count")
  checkoutCount   Int      @default(0) @map("checkout_count")
  orderCount      Int      @default(0) @map("order_count")
  conversionRate  Decimal? @map("conversion_rate") @db.Decimal(5, 2)
  // Revenue
  grossRevenue    Decimal  @default(0) @map("gross_revenue") @db.Decimal(15, 2)
  netRevenue      Decimal  @default(0) @map("net_revenue") @db.Decimal(15, 2)
  avgOrderValue   Decimal? @map("avg_order_value") @db.Decimal(15, 2)
  // Items
  itemsSold       Int      @default(0) @map("items_sold")
  // Returns
  returnCount     Int      @default(0) @map("return_count")
  returnAmount    Decimal  @default(0) @map("return_amount") @db.Decimal(15, 2)
  createdAt       DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@unique([sellerId, date])
  @@index([date])
  @@map("seller_daily_stat")
}

// =============================================================================
// SERVICE OUTBOX (For future Kafka migration)
// =============================================================================

model ServiceOutbox {
  id            String    @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  aggregateType String    @map("aggregate_type") @db.VarChar(100)
  aggregateId   String    @map("aggregate_id") @db.Uuid
  eventType     String    @map("event_type") @db.VarChar(100)
  payload       Json
  metadata      Json?
  isPublished   Boolean   @default(false) @map("is_published")
  publishedAt   DateTime? @map("published_at") @db.Timestamptz(6)
  retryCount    Int       @default(0) @map("retry_count")
  lastError     String?   @map("last_error")
  createdAt     DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)

  @@index([isPublished, createdAt])
  @@index([aggregateType, aggregateId])
  @@map("service_outbox")
}

// =============================================================================
// ENUMS
// =============================================================================

enum BusinessType {
  individual
  company
  cv
  pt
}

enum VerificationStatus {
  pending
  in_review
  verified
  rejected
  expired
}

enum SellerStatus {
  pending
  active
  suspended
  banned
  closed
}

enum SellerDocType {
  id_card        // KTP
  business_license // SIUP/NIB
  tax_id         // NPWP
  bank_statement
  selfie_with_id
  other
}

enum DocStatus {
  pending
  verified
  rejected
  expired
}

enum PayoutStatus {
  pending
  approved
  processing
  paid
  rejected
  cancelled
}

enum PayoutFrequency {
  daily
  weekly
  biweekly
  monthly
}
